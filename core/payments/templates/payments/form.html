{% load humanize %}
<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>ثبت واریزی</title>

    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">

    <script src="https://cdn.jsdelivr.net/npm/cleave.js@1.6.0/dist/cleave.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

    <style>
        body { font-family: Vazir, sans-serif; direction: rtl; background-color: #f7f7f7; padding: 20px; }
        h2 { text-align: center; margin-bottom: 20px; }
        .top-bar { max-width: 1100px; margin: 0 auto 16px auto; display: flex; justify-content: space-between; gap: 8px; flex-wrap: wrap; }
        .top-actions { display: flex; gap: 8px; }
        .user-chip {
            background: #ffffff;
            border: 1px solid #d9d9d9;
            color: #222;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 13px;
            margin-bottom: 6px;
            text-align: center;
        }
        .logout-wrap { display: flex; flex-direction: column; align-items: flex-end; }

        .button-link, .logout-btn { border: none; border-radius: 5px; padding: 8px 14px; cursor: pointer; text-decoration: none; color: #fff; display: inline-block; }
        .logout-btn { background-color: #dc3545; }
        .button-link { background: #0d6efd; }
        .logout-form { margin: 0; }

        #payment-form { max-width: 500px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        #payment-form button { background-color: #007bff; color: #fff; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; }

        input, select, textarea { width: 100%; padding: 8px; margin: 5px 0 15px 0; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; }

        .filter-box { max-width: 1200px; margin: 20px auto 0; background: #fff; padding: 16px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; align-items: end; }
        .filter-grid label { display: block; margin-bottom: 4px; font-size: 13px; }
        .filter-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .filter-actions button, .filter-actions a { border: none; border-radius: 5px; padding: 8px 12px; cursor: pointer; text-decoration: none; text-align: center; }
        .apply-btn { background: #0d6efd; color: #fff; }
        .clear-btn { background: #6c757d; color: #fff; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: center; vertical-align: top; }
        th { background-color: #007bff; color: white; }

        tr.summary-row { cursor: pointer; }
        tr.summary-row:hover { background: #f5f9ff; }
        tr.detail-row { display: none; background: #fafafa; }
        tr.detail-row.open { display: table-row; }

        .status-pill { display: inline-block; padding: 4px 10px; border-radius: 16px; color: #fff; font-size: 12px; line-height: 1.5; }
        .flag-chip { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin: 2px; color: #fff; }
        .flag-blue { background: #1e88e5; }
        .flag-purple { background: #7b1fa2; }
        .flag-green { background: #2e7d32; }
        .flag-red { background: #c62828; }
        .flag-yellow { background: #f9a825; color: #111; }
        .flag-gray { background: #546e7a; }

        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; text-align: right; }
        .detail-card { background: #fff; border: 1px solid #e6e6e6; border-radius: 8px; padding: 10px; }

        .staff-action textarea { min-height: 58px; }
        .staff-action button { border: none; border-radius: 5px; padding: 8px 10px; background: #198754; color: #fff; cursor: pointer; width: 100%; }
        .staff-quick { display: flex; gap: 6px; align-items: center; justify-content: center; flex-wrap: wrap; }
        .staff-quick select, .staff-quick input { width: auto; min-width: 140px; margin: 0; }
        .staff-quick button { border: none; border-radius: 5px; padding: 6px 10px; background: #198754; color: #fff; cursor: pointer; }
        .expand-btn { border: none; border-radius: 5px; padding: 6px 10px; background: #0d6efd; color: #fff; cursor: pointer; margin-top: 6px; }
        .timeline-list { margin: 0; padding-right: 18px; }
        .timeline-list li { margin-bottom: 6px; }
        .tiny { color: #666; font-size: 12px; }

        .edit-link { display: inline-block; background: #fd7e14; color: #fff; border-radius: 5px; padding: 6px 10px; text-decoration: none; margin-bottom: 6px; }
        .track-link { display: inline-block; background: #0d6efd; color: #fff; border-radius: 5px; padding: 6px 10px; text-decoration: none; }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="top-actions">
            {% if can_manage_counterparties %}
                <a href="{% url 'counterparties_manage' %}" class="button-link">مدیریت طرف حساب</a>
            {% endif %}
            {% if can_export_records %}
                <a href="{% url 'export_records' %}?{{ request.GET.urlencode }}" class="button-link">خروجی اکسل</a>
            {% endif %}
        </div>
        <div class="logout-wrap">
            <div class="user-chip">{{ user_display_name }}</div>
            <form class="logout-form" method="post" action="{% url 'logout' %}">
                {% csrf_token %}
                <button type="submit" class="logout-btn">خروج از حساب</button>
            </form>
        </div>
    </div>

    {% if not is_staff_user %}
        <h2>ثبت اطلاعات واریزی</h2>
        <form id="payment-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.as_p }}
            {% if payer_profiles %}
                <p>
                    <label for="payer_profile_picker">استفاده از اطلاعات قبلی</label>
                    <select id="payer_profile_picker">
                        <option value="">انتخاب کنید</option>
                        {% for profile in payer_profiles %}
                            <option value="{{ forloop.counter0 }}">
                                {{ profile.payer_bank_name }} | {{ profile.payer_bank_branch }} | {{ profile.payer_account_number }} | {{ profile.payer_first_name }} {{ profile.payer_last_name }}
                            </option>
                        {% endfor %}
                    </select>
                </p>
            {% endif %}
            <button type="submit">ثبت</button>
        </form>
        {{ payer_profiles|json_script:"payer-profiles-data" }}
    {% else %}
        <h2>بررسی اسناد ارسالی</h2>
    {% endif %}

    <h2>گزارش واریزی ها{% if is_staff_user %}{% if staff_role_label == 'مالی' or staff_role_label == 'بازرگانی' %} - {{ staff_role_label }}{% endif %}{% endif %}</h2>

    <div class="filter-box">
        <form method="get" class="filter-grid">
            {% if is_staff_user %}
                <div><label for="first_name">نام</label><input id="first_name" type="text" name="first_name" value="{{ filters.first_name }}"></div>
                <div><label for="last_name">نام خانوادگی</label><input id="last_name" type="text" name="last_name" value="{{ filters.last_name }}"></div>
                <div><label for="phone">شماره تلفن</label><input id="phone" type="text" name="phone" value="{{ filters.phone }}"></div>
                <div><label for="city">شهر</label><input id="city" type="text" name="city" value="{{ filters.city }}"></div>
                <div><label for="tracking_code">کد پیگیری</label><input id="tracking_code" type="text" name="tracking_code" value="{{ filters.tracking_code }}"></div>
                <div><label for="payer_first_name">نام واریز کننده</label><input id="payer_first_name" type="text" name="payer_first_name" value="{{ filters.payer_first_name }}"></div>
                <div><label for="payer_last_name">نام خانوادگی واریز کننده</label><input id="payer_last_name" type="text" name="payer_last_name" value="{{ filters.payer_last_name }}"></div>
                <div><label for="payer_account_number">شماره حساب واریز کننده</label><input id="payer_account_number" type="text" name="payer_account_number" value="{{ filters.payer_account_number }}"></div>
                <div><label for="payer_bank_name">نام بانک</label><input id="payer_bank_name" type="text" name="payer_bank_name" value="{{ filters.payer_bank_name }}"></div>
                <div><label for="payer_bank_branch">شعبه</label><input id="payer_bank_branch" type="text" name="payer_bank_branch" value="{{ filters.payer_bank_branch }}"></div>
                <div>
                    <label for="counterparty">طرف حساب</label>
                    <select id="counterparty" name="counterparty">
                        <option value="">همه</option>
                        {% for cp in counterparties %}
                            <option value="{{ cp.id }}" {% if filters.counterparty == cp.id|stringformat:"s" %}selected{% endif %}>{{ cp.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}
            <div><label for="amount_filter">مبلغ</label><input id="amount_filter" type="text" name="amount" value="{{ filters.amount }}"></div>
            <div><label for="pay_date_filter">تاریخ (YYYY/MM/DD)</label><input id="pay_date_filter" class="jalali-date" type="text" name="pay_date" value="{{ filters.pay_date }}"></div>
            <div>
                <label for="status">وضعیت</label>
                <select id="status" name="status">
                    <option value="">همه</option>
                    {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if filters.status == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-actions">
                <button type="submit" class="apply-btn">اعمال فیلتر</button>
                <a href="{% url 'submit' %}" class="clear-btn">حذف فیلتر</a>
            </div>
        </form>
    </div>

    <table>
        <thead>
            <tr>
                <th>نام مشتری</th>
                <th>مبلغ</th>
                <th>تاریخ</th>
                <th>وضعیت</th>
                <th>اقدام سریع</th>
            </tr>
        </thead>
        <tbody>
            {% for payment in records %}
            <tr class="summary-row" data-row="{{ payment.id }}">
                <td>{{ payment.first_name }} {{ payment.last_name }}</td>
                <td>{{ payment.amount|intcomma }}</td>
                <td>{{ payment.pay_date }}</td>
                <td>
                    {% if is_staff_user %}
                        <span class="status-pill {{ payment.status_flag_class }}">&#9873; {{ payment.get_status_display }}</span>
                    {% else %}
                        <span class="status-pill {{ payment.customer_flag_class }}">&#9873; {{ payment.customer_status_label }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if not is_staff_user %}
                        {% if payment.status == 'incomplete' %}
                            <a class="edit-link" href="{% url 'edit_payment' payment.id %}">ویرایش</a>
                        {% endif %}
                        <a class="track-link" href="{% url 'payment_timeline' payment.id %}">پیگیری وضعیت</a>
                    {% else %}
                        {% if payment.staff_can_act %}
                            <form class="staff-quick" method="post" action="{% url 'staff_update_status' payment.id %}">
                                {% csrf_token %}
                                <select name="status" required>
                                    {% for value, label in payment.staff_allowed_choices %}
                                        <option value="{{ value }}" {% if payment.status == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                                <input type="text" name="note" placeholder="توضیح (برای رد/ناقص الزامی)">
                                {% if staff_user_role == 'commercial' or staff_user_role == 'staff' %}
                                    <select name="counterparty">
                                        <option value="">بدون طرف حساب</option>
                                        {% for cp in counterparties %}
                                            <option value="{{ cp.id }}" {% if payment.counterparty_id == cp.id %}selected{% endif %}>{{ cp.name }}</option>
                                        {% endfor %}
                                    </select>
                                {% endif %}
                                <button type="submit">ثبت</button>
                            </form>
                        {% else %}
                            <span title="قفل">🔒</span>
                        {% endif %}
                        <button type="button" class="expand-btn" data-row="{{ payment.id }}">نمایش جزئیات</button>
                    {% endif %}
                </td>
            </tr>
            <tr class="detail-row" id="detail-{{ payment.id }}">
                <td colspan="5">
                    <div class="detail-grid">
                        <div class="detail-card">
                            <strong>اطلاعات رکورد</strong>
                            <div>مجموعه: {{ payment.organization }}</div>
                            <div>شهر: {{ payment.city }}</div>
                            <div>شماره تلفن: {{ payment.phone }}</div>
                            <div>نام واریز کننده: {% if payment.payer_first_name and payment.payer_first_name != 'Z' %}{{ payment.payer_first_name }}{% else %}-{% endif %}</div>
                            <div>نام خانوادگی واریز کننده: {% if payment.payer_last_name and payment.payer_last_name != 'Z' %}{{ payment.payer_last_name }}{% else %}-{% endif %}</div>
                            <div>شماره حساب واریز کننده: {% if payment.payer_account_number and payment.payer_account_number != 'Z' %}{{ payment.payer_account_number }}{% else %}-{% endif %}</div>
                            <div>نام بانک: {% if payment.payer_bank_name and payment.payer_bank_name != 'Z' %}{{ payment.payer_bank_name }}{% else %}-{% endif %}</div>
                            <div>شعبه: {% if payment.payer_bank_branch and payment.payer_bank_branch != 'Z' %}{{ payment.payer_bank_branch }}{% else %}-{% endif %}</div>
                            <div>کد پیگیری: {{ payment.tracking_code|default:'-' }}</div>
                            {% if is_staff_user %}<div>طرف حساب: {{ payment.counterparty|default:'-' }}</div>{% endif %}
                            {% if payment.status == 'rejected' or payment.status == 'incomplete' %}
                                <div>توضیح کارشناس: {{ payment.last_staff_note|default:'-' }}</div>
                            {% elif is_staff_user %}
                                <div>آخرین توضیح: {{ payment.last_staff_note|default:'-' }}</div>
                            {% endif %}
                        </div>

                        <div class="detail-card">
                            <strong>اسناد</strong>
                            <div>
                                {% with receipts=payment.receipts.all %}
                                    {% if receipts %}
                                        {% for receipt in receipts %}
                                            <a href="{{ receipt.image.url }}" target="_blank">مشاهده {{ forloop.counter }}</a>{% if not forloop.last %} | {% endif %}
                                        {% endfor %}
                                    {% elif payment.receipt_image %}
                                        <a href="{{ payment.receipt_image.url }}" target="_blank">مشاهده</a>
                                    {% else %}
                                        -
                                    {% endif %}
                                {% endwith %}
                            </div>
                        </div>

                        <div class="detail-card">
                            <strong>گراف تغییرات</strong>
                            <ul class="timeline-list">
                                {% for row in payment.timeline_lines %}
                                    <li>
                                        {{ row.text }}
                                        <div class="tiny">{{ row.time }}</div>
                                        {% if row.note %}<div class="tiny">توضیح: {{ row.note }}</div>{% endif %}
                                    </li>
                                {% empty %}
                                    <li>تاریخچه‌ای ثبت نشده است.</li>
                                {% endfor %}
                            </ul>
                            <a href="{% url 'payment_timeline' payment.id %}">نمایش کامل تاریخچه</a>
                        </div>

                        {% if is_staff_user %}
                        <div class="detail-card">
                            <strong>تغییر وضعیت و توضیح</strong>
                            {% if payment.staff_can_act %}
                                <form class="staff-action" method="post" action="{% url 'staff_update_status' payment.id %}">
                                    {% csrf_token %}
                                    <select name="status" required>
                                        {% for value, label in payment.staff_allowed_choices %}
                                            <option value="{{ value }}" {% if payment.status == value %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                    <textarea name="note" placeholder="توضیح برای مشتری (برای رد/ناقص الزامی)"></textarea>
                                    {% if staff_user_role == 'commercial' or staff_user_role == 'staff' %}
                                        <select name="counterparty">
                                            <option value="">بدون طرف حساب</option>
                                            {% for cp in counterparties %}
                                                <option value="{{ cp.id }}" {% if payment.counterparty_id == cp.id %}selected{% endif %}>{{ cp.name }}</option>
                                            {% endfor %}
                                        </select>
                                    {% endif %}
                                    <button type="submit">ثبت تغییرات</button>
                                </form>
                            {% else %}
                                <div class="tiny">در این مرحله امکان تغییر وضعیت برای نقش شما وجود ندارد.</div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="5">اطلاعاتی موجود نیست</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
    $(document).ready(function(){
        $('.jalali-date').persianDatepicker({
            format: 'YYYY/MM/DD',
            observer: true,
            initialValue: false
        });

        const amountEl = document.querySelector('.amount-input');
        if (amountEl) {
            new Cleave(amountEl, {
                numeral: true,
                numeralThousandsGroupStyle: 'thousand'
            });
        }

        const paymentForm = document.querySelector('#payment-form');
        if (paymentForm) {
            paymentForm.addEventListener('submit', function () {
                const amountInput = document.querySelector('.amount-input');
                if (amountInput) {
                    amountInput.value = amountInput.value.replace(/,/g, '');
                }
            });
        }

        const profilePicker = document.getElementById('payer_profile_picker');
        const profileDataEl = document.getElementById('payer-profiles-data');
        if (profilePicker && profileDataEl) {
            const profiles = JSON.parse(profileDataEl.textContent || '[]');
            profilePicker.addEventListener('change', function () {
                const idx = parseInt(profilePicker.value, 10);
                if (Number.isNaN(idx) || !profiles[idx]) return;
                const selected = profiles[idx];
                const fieldMap = {
                    payer_account_number: selected.payer_account_number || '',
                    payer_first_name: selected.payer_first_name || '',
                    payer_last_name: selected.payer_last_name || '',
                    payer_bank_name: selected.payer_bank_name || '',
                    payer_bank_branch: selected.payer_bank_branch || ''
                };
                Object.keys(fieldMap).forEach(function (name) {
                    const input = document.querySelector('[name="' + name + '"]');
                    if (input) input.value = fieldMap[name];
                });
            });
        }

        function closeAllDetails(exceptId) {
            document.querySelectorAll('tr.detail-row.open').forEach(function (row) {
                if (!exceptId || row.id !== ('detail-' + exceptId)) {
                    row.classList.remove('open');
                }
            });
        }

        function openExclusive(id) {
            closeAllDetails(id);
            const detail = document.getElementById('detail-' + id);
            if (detail) {
                detail.classList.add('open');
            }
        }

        function toggleWithMode(id, multiMode) {
            const detail = document.getElementById('detail-' + id);
            if (!detail) return;
            if (multiMode) {
                detail.classList.toggle('open');
                return;
            }
            if (detail.classList.contains('open')) {
                detail.classList.remove('open');
                return;
            }
            openExclusive(id);
        }

        document.querySelectorAll('tr.summary-row').forEach(function (row) {
            row.addEventListener('click', function (event) {
                const interactive = event.target.closest('a, button, input, select, textarea, form');
                if (interactive) return;
                toggleWithMode(row.getAttribute('data-row'), event.ctrlKey || event.metaKey);
            });
        });

        document.querySelectorAll('.expand-btn').forEach(function (btn) {
            btn.addEventListener('click', function (event) {
                toggleWithMode(btn.getAttribute('data-row'), event.ctrlKey || event.metaKey);
            });
        });
    });
    </script>
</body>
</html>
